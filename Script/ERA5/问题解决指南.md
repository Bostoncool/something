# ERA5数据下载问题解决指南

## 问题分析

您遇到的错误主要有两个：

1. **HTTP 429错误**：`Too Many Requests` - 请求过于频繁
2. **连接超时错误**：`Connection to cds.climate.copernicus.eu timed out` - 网络连接问题

## 解决方案

### 1. 立即解决方案

#### 方案A：使用优化版本脚本
```bash
python Mutithread_optimized.py
```

**主要改进：**
- 降低并发数到1个线程
- 添加重试机制（最多3次）
- 增加请求间隔（60秒）
- 减少数据量（只下载2024年1-2月）
- 减少时间分辨率（每6小时一次）

#### 方案B：先测试连接
```bash
python test_connection.py
```

这个脚本会：
- 检查CDS API配置
- 测试网络连接
- 下载一个小的测试文件

### 2. 配置检查

#### 检查CDS API配置
1. 确保您有CDS账户：https://cds.climate.copernicus.eu/
2. 获取API密钥：
   - 登录CDS网站
   - 点击右上角用户名 → "Your profile"
   - 复制API密钥

3. 创建配置文件：
   - Windows: `%USERPROFILE%\.cdsapirc`
   - Linux/Mac: `~/.cdsapirc`

配置文件内容：
```yaml
url: https://cds.climate.copernicus.eu/api/v2
key: YOUR_ACTUAL_API_KEY
```

### 3. 网络优化

#### 解决连接超时问题：
1. **检查网络连接**
   ```bash
   ping cds.climate.copernicus.eu
   ```

2. **使用VPN**（如果在中国大陆）
   - CDS服务器在欧洲，可能需要VPN访问

3. **增加超时时间**
   - 在脚本中增加连接超时设置

### 4. 数据量优化

#### 减少数据量的方法：

1. **时间范围**：
   ```python
   years = range(2024, 2025)  # 只下载1年
   months = range(1, 3)       # 只下载2个月
   ```

2. **时间分辨率**：
   ```python
   'time': [f"{h:02d}:00" for h in range(0, 24, 6)]  # 每6小时
   ```

3. **空间范围**：
   ```python
   'area': [41, 115, 39, 117]  # 缩小地理区域
   ```

4. **变量数量**：
   ```python
   'variable': 'surface_pressure'  # 只下载一个变量
   ```

### 5. 分批下载策略

#### 推荐的分批方案：

1. **按年份分批**：
   ```python
   # 第一批：2020-2022
   years = range(2020, 2023)
   
   # 第二批：2023-2024
   years = range(2023, 2025)
   ```

2. **按季节分批**：
   ```python
   # 春季
   months = [3, 4, 5]
   
   # 夏季
   months = [6, 7, 8]
   ```

3. **按月分批**：
   ```python
   # 每次只下载1个月
   months = [1]  # 只下载1月
   ```

### 6. 错误处理策略

#### 自动重试机制：
```python
RETRY_ATTEMPTS = 3     # 重试3次
RETRY_DELAY = 300      # 等待5分钟
REQUEST_DELAY = 60     # 请求间隔1分钟
```

#### 错误类型处理：
- **429错误**：等待更长时间后重试
- **连接超时**：检查网络后重试
- **其他错误**：记录日志并跳过

### 7. 监控和日志

#### 启用详细日志：
```python
import logging
logging.basicConfig(level=logging.INFO)
```

#### 查看下载进度：
- 脚本会显示每个文件的下载状态
- 日志文件记录详细信息

### 8. 替代方案

#### 如果仍然无法下载：

1. **使用CDS网站界面**：
   - 访问 https://cds.climate.copernicus.eu/
   - 手动选择数据并下载

2. **使用其他数据源**：
   - NASA GES DISC
   - NOAA NCEP
   - 本地气象站数据

3. **联系CDS支持**：
   - 如果问题持续，可以联系CDS技术支持

## 使用步骤

### 第一步：测试连接
```bash
python test_connection.py
```

### 第二步：如果测试成功，开始下载
```bash
python Mutithread_optimized.py
```

### 第三步：监控下载进度
- 查看控制台输出
- 检查日志文件 `era5_download.log`

## 常见问题

### Q: 为什么会出现429错误？
A: CDS有请求频率限制，同时发起多个请求会触发限流。

### Q: 如何避免连接超时？
A: 使用稳定的网络连接，必要时使用VPN，增加超时时间。

### Q: 下载速度很慢怎么办？
A: 这是正常的，ERA5数据量很大，建议分批下载。

### Q: 可以同时下载多个文件吗？
A: 不建议，容易触发限流。建议使用单线程顺序下载。

## 联系支持

如果问题仍然存在，请：
1. 检查网络连接
2. 验证CDS账户状态
3. 查看CDS服务状态页面
4. 联系CDS技术支持

| **类别**   | **核心变量**                                                                  |
| -------- | ------------------------------------------------------------------------- |
| **风场**   | `10m_u/v_component_of_wind`, `boundary_layer_height`                      |
| **降水**   | `total_precipitation`, `mean_total_precipitation_rate`                    |
| **湿度**   | `2m_dewpoint_temperature`, `total_column_water_vapour`                    |
| **温度**   | `2m_temperature`, `minimum_2m_temperature_since_previous_post_processing` |
| **地表特征** | `land_sea_mask`, `high/low_vegetation_cover`                              |
