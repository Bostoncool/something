%% 北京 PM2.5 预测 XGBoost 代码流程图
%% 作者：AI 助手
%% 日期：2025-06-25

%% ---------------- 主流程 ----------------
flowchart TD
    A([开始]):::startEnd
    A --> B[导入库 & 配置参数]:::dataProc
    B --> C[读取污染数据\n2015-2024]:::dataProc
    B --> D[读取 ERA5 气象数据\n2015-2024]:::dataProc
    C & D --> E[合并数据 & 特征工程]:::featureEng
    E --> F[划分训练/验证/测试\n2015-20/21/22-24]:::dataProc
    F --> G[训练基础 XGBoost]:::modelTrain
    G --> H[是否优化?]:::eval
    H -->|是| I[GridSearchCV 调参]:::modelTrain
    I --> J[重新训练优化模型]:::modelTrain
    H -->|否| K[使用基础模型]:::modelTrain
    J & K --> L[评估模型\nR² RMSE MAE MAPE]:::eval
    L --> M[特征重要性分析]:::eval
    M --> N[生成 7 张可视化图]:::eval
    N --> O[保存结果\nCSV/PNG/PKL]:::save
    O --> P([结束]):::startEnd

%% ---------------- 子流程 ----------------
    %% 污染数据读取
    C --> C1[read_all_pollution]:::dataProc
    C1 --> C2[多进程并行\n每日 CSV]:::dataProc
    C2 --> C3[合并 & 缺失值填充]:::dataProc

    %% ERA5 读取
    D --> D1[read_all_era5]:::dataProc
    D1 --> D2[多进程并行\n每月 NetCDF]:::dataProc
    D2 --> D3[裁剪北京区域\n日均重采样]:::dataProc

    %% 特征工程
    E --> E1[时间特征\n滞后/滚动/差分]:::featureEng
    E1 --> E2[气象特征\n风速风向湿度]:::featureEng
    E2 --> E3[供暖季 & 季节]:::featureEng

    %% 模型训练
    G --> G1[基础参数\nmax_depth=8 ...]:::modelTrain
    G1 --> G2[GPU 加速\nearly_stopping=80]:::modelTrain

    %% 评估
    L --> L1[训练/验证/测试集]:::eval
    L1 --> L2[对比 Basic vs Optimized]:::eval

    %% 可视化
    N --> N1[训练曲线]:::eval
    N --> N2[散点/时序/残差]:::eval
    N --> N3[特征重要性]:::eval
    N --> N4[误差分布]:::eval

%% 节点样式
classDef startEnd fill:#FFE135,stroke:#333,stroke-width:2px,color:#000
classDef dataProc fill:#78C0E0,stroke:#333,stroke-width:2px,color:#000
classDef featureEng fill:#84DCC6,stroke:#333,stroke-width:2px,color:#000
classDef modelTrain fill:#F18F01,stroke:#333,stroke-width:2px,color:#000
classDef eval fill:#C0362C,stroke:#333,stroke-width:2px,color:#FFF
classDef save fill:#8E44AD,stroke:#333,stroke-width:2px,color:#FFF