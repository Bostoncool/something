# Spearman相关性分析 - 风速计算修复说明

## 修复概述

本次修复参考了 Kendall-Correlation 文件夹中的实现，完善了 Spearman-Correlation 分析中的风速数据处理功能。

## 主要修改内容

### 1. 增强 `collect_all_meteo_files()` 方法

**修改位置**: 第 111-138 行

**修改内容**:
- 增加了第二种文件搜索方法：搜索所有CSV文件（包括风分量数据）
- 合并并去重两种搜索方法的结果
- 添加风分量文件统计和展示功能

**主要改进**:
```python
# 方法2：搜索所有CSV文件（包括风分量等特殊命名的文件）
search_pattern = os.path.join(self.meteo_data_dir, "**", "*.csv")
all_csv_files = glob.glob(search_pattern, recursive=True)

# 合并并去重
all_files_set = set(all_files + all_csv_files)
all_files = list(all_files_set)

# 统计风分量文件
wind_files = [f for f in all_files if any(wind in os.path.basename(f).lower() 
             for wind in ['u10', 'v10', 'u100', 'v100', 'wind'])]
```

### 2. 新增 `aggregate_spatial_data()` 方法

**位置**: 第 149-178 行

**功能**: 聚合空间数据，将多维数据(time, latitude, longitude)转换为时间序列

**主要特性**:
- 按时间分组计算空间平均值
- 自动识别数值列并排除空间坐标列
- 完善的异常处理

### 3. 新增 `process_wind_component_data()` 方法

**位置**: 第 180-218 行

**功能**: 专门处理风分量数据

**主要特性**:
- 移除 NaN 值
- 移除异常值（风分量范围：-100 到 100 m/s）
- 对大数据集进行采样（>50000条数据时）
- 返回标准统计信息（mean, std, min, max）

### 4. 增强 `calculate_stats_vectorized()` 方法

**位置**: 第 220-265 行

**修改内容**:
- 添加多维数据处理能力（2D和3D数组）
- 按时间维度聚合空间数据
- 移除无效值处理
- 大数据集采样优化（>10000条数据时）

**核心改进**:
```python
# 处理多维数据 - 如果是2D或3D数组，展平为1D
if hourly_data.ndim > 1:
    if hourly_data.ndim == 3:  # (time, lat, lon)
        hourly_data = np.nanmean(hourly_data, axis=(1, 2))
    elif hourly_data.ndim == 2:  # (time, spatial)
        hourly_data = np.nanmean(hourly_data, axis=1)

# 移除无效值
valid_data = hourly_data[~np.isnan(hourly_data)]

# 如果数据量太大，进行采样以避免内存问题
if len(valid_data) > 10000:
    step = len(valid_data) // 10000
    valid_data = valid_data[::step]
```

### 5. 增强 `process_single_meteo_file()` 方法

**位置**: 第 267-360 行

**主要改进**:

#### 5.1 多编码格式支持
```python
try:
    df = pd.read_csv(filepath, encoding='utf-8', comment='#')
except UnicodeDecodeError:
    try:
        df = pd.read_csv(filepath, encoding='gbk', comment='#')
    except UnicodeDecodeError:
        df = pd.read_csv(filepath, encoding='latin-1', comment='#')
```

#### 5.2 处理CSV注释行
- 添加 `comment='#'` 参数自动跳过注释行
- 处理 ParserError 异常

#### 5.3 处理多索引数据
```python
if 'time' in df.columns and 'latitude' in df.columns and 'longitude' in df.columns:
    df = self.aggregate_spatial_data(df)
```

#### 5.4 风分量数据特殊处理
```python
elif col in ['u10', 'v10', 'u100', 'v100']:
    # 风分量数据特殊处理
    daily_stats = self.process_wind_component_data(df, col)
```

#### 5.5 改进年月信息提取
```python
# 尝试从文件名中提取年月（格式：YYYYMM.csv）
if len(filename) >= 6 and filename[:4].isdigit() and filename[4:6].isdigit():
    year = int(filename[:4])
    month = int(filename[4:6])
else:
    # 如果文件名不包含年月信息，尝试从路径中提取
    import re
    match = re.search(r'(\d{4})(\d{2})', filepath)
    if match:
        monthly_stats['year'] = int(match.group(1))
        monthly_stats['month'] = int(match.group(2))
```

#### 5.6 增强列级别异常处理
```python
except Exception as col_error:
    print(f"Error processing column {col} in {os.path.basename(filepath)}: {col_error}")
    monthly_stats[f'{col}_mean'] = np.nan
    monthly_stats[f'{col}_std'] = np.nan
    monthly_stats[f'{col}_min'] = np.nan
    monthly_stats[f'{col}_max'] = np.nan
```

### 6. 增强 `prepare_combined_data()` 方法

**位置**: 第 569-580 行

**新增功能**:
- 统计风分量参数数量
- 展示风分量参数列表
- 如果未找到风分量数据则发出警告

```python
# Count wind component features
wind_features = [col for col in combined_data.columns 
                if any(w in col for w in ['u10', 'v10', 'u100', 'v100'])]

print(f"Number of wind component parameters: {len(wind_features)}")

if wind_features:
    print(f"Wind component parameters: {wind_features}")
else:
    print("Warning: No wind component parameters found in combined data!")
```

## 预期效果

修复后，程序应该能够：

1. **正确识别和加载风分量数据文件**
   - 从子目录中搜索风分量CSV文件
   - 显示找到的风分量文件数量和示例

2. **正确处理风分量数据**
   - 处理多维数组（time, latitude, longitude）
   - 移除异常值和NaN值
   - 对大数据集进行采样优化

3. **在热力图中显示风分量相关性**
   - u10_mean, u10_std, u10_min, u10_max
   - v10_mean, v10_std, v10_min, v10_max
   - u100_mean, u100_std, u100_min, u100_max
   - v100_mean, v100_std, v100_min, v100_max

## 运行输出示例

修复后，运行程序时应该看到类似的输出：

```
Found 2280 meteorological data files
  Including 480 wind component related files
  Examples: ['201501.csv', '201502.csv', '201503.csv']

...

Preparing combined data...
Meteorological data shape: (120, 72)
Pollution data shape: (120, 6)
Extra pollution data shape: (120, 8)
Combined data shape: (120, 86)
Final data shape: (120, 86)

Number of meteorological parameters: 72
Number of pollution parameters: 14
Number of wind component parameters: 16
Wind component parameters: ['u10_mean', 'u10_std', 'u10_min', 'u10_max', 
                            'v10_mean', 'v10_std', 'v10_min', 'v10_max',
                            'u100_mean', 'u100_std', 'u100_min', 'u100_max',
                            'v100_mean', 'v100_std', 'v100_min', 'v100_max']
```

## 技术要点

### 处理的主要问题

1. **文件搜索问题**: 风分量数据存储在子目录中，原代码只搜索主目录
2. **数据维度问题**: 风分量数据包含多维结构（time×latitude×longitude）
3. **CSV格式问题**: 从NC转换的CSV文件包含注释行
4. **内存优化**: 大数据集需要采样以避免内存溢出
5. **异常值处理**: 风分量数据需要特殊的值范围验证

### 性能优化

1. **数据采样**:
   - 风分量数据: >50000条时采样
   - 通用数据: >10000条时采样

2. **内存优化**:
   - 使用 `downcast` 优化数据类型
   - 及时清理缓存

3. **并行处理**:
   - 保持原有的多进程并行加载功能

## 注意事项

1. 确保风分量数据文件位于正确的子目录结构中
2. 风分量数据应该包含正确的列名（u10, v10, u100, v100）
3. 如果数据包含空间维度，确保有 time, latitude, longitude 列
4. 定期检查处理日志以识别数据质量问题

## 参考文档

更多详细信息请参考：
- `Kendall-Correlation/WIND_DATA_FIX_SUMMARY.md` - 问题分析和修复方案
- `Kendall-Correlation/使用说明.md` - 使用指南和验证方法

