# 风分量数据处理和显示 - 使用说明

## 问题说明

您的数据可以处理u10, v10, u100, v100四个风分量列，但没有在热力图上体现。

## 根本原因

经过诊断发现了两个关键问题：

### 1. 风分量数据存储在子目录中
您的数据结构是这样的：
```
C:\Users\IU\Desktop\Datebase Origin\ERA5-Beijing-CSV\
  ├── 10m_u_component_of_wind\    (120个CSV文件: 201501.csv - 202412.csv)
  ├── 10m_v_component_of_wind\    (120个CSV文件)
  ├── 100m_u_component_of_wind\   (120个CSV文件)
  ├── 100m_v_component_of_wind\   (120个CSV文件)
  ├── 2m_temperature\
  ├── boundary_layer_height\
  └── ... (其他气象参数子目录)
```

原代码只搜索主目录下按`YYYYMM.csv`格式命名的文件，无法找到子目录中的风分量数据。

### 2. 风分量CSV文件包含注释行
从NC文件转换的CSV文件包含以`#`开头的元数据注释行，导致pandas读取时出现解析错误。

## 已实施的修复

### 修复1：增强文件搜索功能
修改了`collect_all_meteo_files()`方法，现在会：
- 搜索所有子目录中的CSV文件
- 自动识别风分量相关文件
- 显示找到的风分量文件数量

```python
def collect_all_meteo_files(self) -> List[str]:
    # 方法1：按年月模式搜索
    # 方法2：搜索所有CSV文件（包括风分量等特殊命名的文件）
    search_pattern = os.path.join(self.meteo_data_dir, "**", "*.csv")
    all_csv_files = glob.glob(search_pattern, recursive=True)
    # 合并并去重
    ...
```

### 修复2：处理CSV注释行
修改了CSV读取逻辑，支持：
- 自动跳过以`#`开头的注释行
- 处理多种编码格式（UTF-8, GBK, Latin-1）
- 容错处理解析错误

```python
df = pd.read_csv(filepath, encoding='utf-8', comment='#')
```

### 修复3：增强调试信息
添加了详细的调试输出，帮助您追踪数据处理过程：
- 显示找到的文件数量和类型
- 显示风分量列的检测结果
- 显示合并后的数据结构

## 验证修复效果

运行修复后的代码时，您应该看到类似的输出：

```
找到 2280 个气象数据文件
  其中包含 480 个风分量相关文件
  示例: ['201501.csv', '201502.csv', '201503.csv']

处理文件: 201501.csv
  数据形状: (744, 7)
  列名: ['time', 'latitude', 'longitude', 'u10', 'v10', 'u100', 'v100']
  发现风分量列: ['u10', 'v10', 'u100', 'v100']
    u10: dtype=float32, non-null count=744, range=[-15.23, 12.45]
    ...
```

在数据合并阶段：
```
最终数据形状: (120, 75)
合并后的列名: ['t2m_mean', 't2m_std', ..., 'u10_mean', 'v10_mean', 'u100_mean', 'v100_mean', ...]
气象参数数量: 68
风分量参数数量: 16  # 4个风分量 × 4个统计量(mean, std, min, max)
风分量参数列表: ['u10_mean', 'u10_std', 'u10_min', 'u10_max', 'v10_mean', ...]
```

## 如果仍然没有显示

如果风分量数据仍未在热力图中显示，请检查以下几点：

### 1. 检查数据是否被正确加载
查看控制台输出，确认：
- ✓ 找到了480个风分量文件（每个风分量类型120个）
- ✓ 风分量列被正确识别
- ✓ 合并后的数据包含风分量列

### 2. 检查数据对齐问题
风分量数据必须与污染数据在时间维度上对齐。确认：
- 风分量文件的年月信息能被正确解析
- 年月范围与污染数据匹配（2015-2024）

### 3. 检查数据质量
- 风分量数据不全为NaN
- 统计量计算正确（mean, std, min, max）

### 4. 检查相关性计算
在Kendall相关性分析中，风分量列应该被包含：
```python
feature_columns = [col for col in combined_data.select_dtypes(include=[np.number]).columns 
                  if col not in ['year', 'month']]
```

## 手动验证数据

如果需要手动检查数据，可以运行以下Python代码：

```python
from old import BeijingKendallAnalyzer

# 创建分析器
analyzer = BeijingKendallAnalyzer(
    meteo_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\ERA5-Beijing-CSV",
    pollution_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\Benchmark\all(AQI+PM2.5+PM10)",
    additional_pollution_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\Benchmark\extra(SO2+NO2+CO+O3)"
)

# 加载数据
analyzer.load_data()

# 准备合并数据
combined_data = analyzer.prepare_combined_data()

# 检查风分量列
wind_cols = [col for col in combined_data.columns if any(w in col for w in ['u10', 'v10', 'u100', 'v100'])]
print(f"风分量列: {wind_cols}")
print(f"风分量数据统计:\n{combined_data[wind_cols].describe()}")
```

## 预期结果

修复后，Kendall相关性热力图应该包含以下风分量相关行/列：
- `u10_mean`, `u10_std`, `u10_min`, `u10_max`
- `v10_mean`, `v10_std`, `v10_min`, `v10_max`
- `u100_mean`, `u100_std`, `u100_min`, `u100_max`
- `v100_mean`, `v100_std`, `v100_min`, `v100_max`

总共16个风分量特征，它们与污染指标（PM2.5, PM10, AQI, SO2, CO, O3, NO2）的相关性将显示在热力图中。

## 技术支持

如果问题仍然存在，请提供以下信息：
1. 控制台完整输出
2. "合并后的列名"的完整列表
3. 热力图图片
4. combined_data.shape 的值
