# Wind Component Data Processing and Display - Usage Guide

## Problem Description

Your data can process four wind component columns (u10, v10, u100, v100), but they are not reflected in the heatmap.

## Root Causes

After diagnosis, two key issues were identified:

### 1. Wind Component Data Stored in Subdirectories
Your data structure is as follows:
```
C:\Users\IU\Desktop\Datebase Origin\ERA5-Beijing-CSV\
  ├── 10m_u_component_of_wind\    (120 CSV files: 201501.csv - 202412.csv)
  ├── 10m_v_component_of_wind\    (120 CSV files)
  ├── 100m_u_component_of_wind\   (120 CSV files)
  ├── 100m_v_component_of_wind\   (120 CSV files)
  ├── 2m_temperature\
  ├── boundary_layer_height\
  └── ... (other meteorological parameter subdirectories)
```

The original code only searches for files named in the `YYYYMM.csv` format in the main directory and cannot find wind component data in subdirectories.

### 2. Wind Component CSV Files Contain Comment Lines
CSV files converted from NC files contain metadata comment lines starting with `#`, causing parsing errors when pandas reads them.

## Implemented Fixes

### Fix 1: Enhanced File Search Functionality
Modified the `collect_all_meteo_files()` method, which now:
- Searches for CSV files in all subdirectories
- Automatically identifies wind component-related files
- Displays the number of wind component files found

```python
def collect_all_meteo_files(self) -> List[str]:
    # Method 1: Search by year-month pattern
    # Method 2: Search all CSV files (including specially named files like wind components)
    search_pattern = os.path.join(self.meteo_data_dir, "**", "*.csv")
    all_csv_files = glob.glob(search_pattern, recursive=True)
    # Merge and deduplicate
    ...
```

### Fix 2: Handle CSV Comment Lines
Modified CSV reading logic to support:
- Automatically skip comment lines starting with `#`
- Handle multiple encoding formats (UTF-8, GBK, Latin-1)
- Fault-tolerant parsing error handling

```python
df = pd.read_csv(filepath, encoding='utf-8', comment='#')
```

### Fix 3: Enhanced Debug Information
Added detailed debug output to help you track the data processing process:
- Display the number and types of files found
- Display wind component column detection results
- Display merged data structure

## Verifying Fix Effectiveness

When running the fixed code, you should see output similar to:

```
Found 2280 meteorological data files
  Including 480 wind component related files
  Examples: ['201501.csv', '201502.csv', '201503.csv']

Processing file: 201501.csv
  Data shape: (744, 7)
  Column names: ['time', 'latitude', 'longitude', 'u10', 'v10', 'u100', 'v100']
  Found wind component columns: ['u10', 'v10', 'u100', 'v100']
    u10: dtype=float32, non-null count=744, range=[-15.23, 12.45]
    ...
```

During data merging stage:
```
Final data shape: (120, 75)
Merged column names: ['t2m_mean', 't2m_std', ..., 'u10_mean', 'v10_mean', 'u100_mean', 'v100_mean', ...]
Number of meteorological parameters: 68
Number of wind component parameters: 16  # 4 wind components × 4 statistics (mean, std, min, max)
Wind component parameter list: ['u10_mean', 'u10_std', 'u10_min', 'u10_max', 'v10_mean', ...]
```

## If Still Not Displayed

If wind component data is still not displayed in the heatmap, check the following:

### 1. Check if Data is Loaded Correctly
View console output and confirm:
- ✓ Found 480 wind component files (120 for each of 4 wind component types)
- ✓ Wind component columns are correctly identified
- ✓ Merged data contains wind component columns

### 2. Check Data Alignment Issues
Wind component data must be aligned with pollution data on the time dimension. Confirm:
- Year-month information in wind component files can be correctly parsed
- Year-month range matches pollution data (2015-2024)

### 3. Check Data Quality
- Wind component data is not all NaN
- Statistics are calculated correctly (mean, std, min, max)

### 4. Check Correlation Calculation
In Kendall correlation analysis, wind component columns should be included:
```python
feature_columns = [col for col in combined_data.select_dtypes(include=[np.number]).columns 
                  if col not in ['year', 'month']]
```

## Manual Data Verification

If you need to manually check the data, run the following Python code:

```python
from old import BeijingKendallAnalyzer

# Create analyzer
analyzer = BeijingKendallAnalyzer(
    meteo_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\ERA5-Beijing-CSV",
    pollution_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\Benchmark\all(AQI+PM2.5+PM10)",
    additional_pollution_data_dir=r"C:\Users\IU\Desktop\Datebase Origin\Benchmark\extra(SO2+NO2+CO+O3)"
)

# Load data
analyzer.load_data()

# Prepare combined data
combined_data = analyzer.prepare_combined_data()

# Check wind component columns
wind_cols = [col for col in combined_data.columns if any(w in col for w in ['u10', 'v10', 'u100', 'v100'])]
print(f"Wind component columns: {wind_cols}")
print(f"Wind component data statistics:\n{combined_data[wind_cols].describe()}")
```

## Expected Results

After the fix, the Kendall correlation heatmap should contain the following wind component-related rows/columns:
- `u10_mean`, `u10_std`, `u10_min`, `u10_max`
- `v10_mean`, `v10_std`, `v10_min`, `v10_max`
- `u100_mean`, `u100_std`, `u100_min`, `u100_max`
- `v100_mean`, `v100_std`, `v100_min`, `v100_max`

A total of 16 wind component features, their correlation with pollution indicators (PM2.5, PM10, AQI, SO2, CO, O3, NO2) will be displayed in the heatmap.

## Technical Support

If the problem persists, please provide the following information:
1. Complete console output
2. Complete list of "merged column names"
3. Heatmap image
4. Value of combined_data.shape
